# .github/workflows/ci_darkwood2.yaml

name: CI & Darkwood2 Deployment Validation

on:
  push:
    branches: [ main, dev, feature/** ]
  pull_request:
    branches: [ main, dev ]

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    env:
      LEDGER_DIR: ledger
      LEDGER_FILE: ledger/events.jsonl
      DEPLOY_MODE: full # Options: full, core, combat, rollback
      COMBAT_SYSTEM: real-time # Options: real-time, turn-based
      COMBAT_FPS: 60
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install AJV CLI
        run: npm install -g ajv-cli

      - name: Validate Scene JSON Files
        run: |
          ajv validate -s schemas/scene.schema.json -d "combat/scenes/*.json" --strict=false

      - name: Validate Log JSON Files
        run: |
          ajv validate -s schemas/log.schema.json -d "combat/logs/*.json" --strict=false

      - name: Darkwood2 Deploy & Audit
        shell: bash
        run: |
          set -euo pipefail
          TIMESTAMP=$(date -u +%FT%TZ)
          SEED=$(tr -dc 'a-z0-9' < /dev/urandom | head -c 8)
          PLATFORM=$(uname -s | tr '[:upper:]' '[:lower:]')
          mkdir -p "$LEDGER_DIR"
          touch "$LEDGER_FILE"

          log_event() {
            local phase="$1"
            local status="$2"
            local msg="$3"
            cat <<EOF >> "$LEDGER_FILE"
{
  "type": "deploy",
  "phase": "$phase",
  "status": "$status",
  "time": "$TIMESTAMP",
  "actor": "$(whoami)",
  "host": "$(hostname)",
  "seed": "$SEED",
  "message": "$msg",
  "combat_system": "$COMBAT_SYSTEM",
  "target_fps": $COMBAT_FPS,
  "platform": "$PLATFORM",
  "script_version": "2.0"
}
EOF
          }

          check_requirements() {
            if ! command -v aln &> /dev/null; then
              log_event "prereq" "failure" "ALN tool not found"
              exit 1
            fi
            if [[ "$COMBAT_SYSTEM" == "real-time" ]] && ! command -v python3 &> /dev/null; then
              log_event "prereq" "failure" "Python3 required for real-time combat"
              exit 1
            fi
          }

          deploy_phase() {
            local phase="$1"
            local args="$2"
            if aln run ops/darkwood2_dev.ing $args; then
              log_event "$phase" "success" "$phase completed"
            else
              log_event "$phase" "failure" "$phase failed"
              exit 1
            fi
          }

          # Phased Deployments
          case "$DEPLOY_MODE" in
            "full")
              check_requirements
              log_event "startup" "running" "Full deployment starting"
              deploy_phase "initialization" "--phase initialization"
              deploy_phase "core_systems" "--phase core_systems"
              deploy_phase "combat_system" "--phase combat --combat-mode $COMBAT_SYSTEM --fps $COMBAT_FPS"
              deploy_phase "full_deployment" "--full"
              case "$PLATFORM" in
                linux*) deploy_phase "platform_opt" "--optimize linux" ;;
                darwin*) deploy_phase "platform_opt" "--optimize macos" ;;
                *)      deploy_phase "platform_opt" "--optimize generic" ;;
              esac
              ;;
            "core") check_requirements
              deploy_phase "initialization" "--phase initialization"
              deploy_phase "core_systems" "--phase core_systems"
              ;;
            "combat") check_requirements
              deploy_phase "combat_system" "--phase combat --combat-mode $COMBAT_SYSTEM --fps $COMBAT_FPS"
              ;;
            "rollback") check_requirements
              deploy_phase "rollback" "--rollback --seed $SEED"
              ;;
            *) echo "Invalid DEPLOY_MODE: $DEPLOY_MODE" ; exit 1 ;;
          esac

          echo "[âœ“] Darkwood2 deployment CI complete"
          echo "[!] Deployment seed: $SEED"
          echo "[!] Ledger file: $LEDGER_FILE"
          echo "[!] Combat system: $COMBAT_SYSTEM mode at $COMBAT_FPS FPS"
